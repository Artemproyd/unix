# Graceful Shutdown –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞

## –û–±–∑–æ—Ä

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ graceful shutdown –¥–ª—è worker'–æ–≤, –∫–æ—Ç–æ—Ä–∞—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:

1. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã** - worker —Å–æ–æ–±—â–∞–µ—Ç gateway –æ –Ω–∞—á–∞–ª–µ shutdown
2. **–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –∑–∞–¥–∞—á** - worker –¥–æ–∂–∏–¥–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º–æ–π –∑–∞–¥–∞—á–∏
3. **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π** - Kafka consumer/producer –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—é—Ç—Å—è
4. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏** - worker —Å–æ–æ–±—â–∞–µ—Ç –æ –ø–æ–ª–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–∞–±–æ—Ç—ã

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Graceful Shutdown

### Worker (analyzer.py)
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤**: SIGTERM/SIGINT –¥–ª—è –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ shutdown
- **–°—Ç–∞—Ç—É—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**: –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ Kafka –≤ —Ç–æ–ø–∏–∫ 'results'
- **–ó–∞—â–∏—â–µ–Ω–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ**: –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏ –ø–µ—Ä–µ–¥ shutdown
- **Timeout**: –º–∞–∫—Å–∏–º—É–º 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏

### Gateway (app.py)
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ worker'–æ–≤**: –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –≤—Å–µ—Ö worker'–æ–≤
- **API endpoints**: `/workers/status` –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π**: –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è shutdown –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

### Docker
- **stop_grace_period**: 45 —Å–µ–∫—É–Ω–¥ –¥–ª—è worker'–æ–≤, 30 –¥–ª—è gateway
- **stop_signal**: SIGTERM –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∏–Ω–∏—Ü–∏–∞—Ü–∏–∏ shutdown

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### 1. –ó–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã
```bash
make build
make up
```

### 2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ graceful shutdown
```bash
# –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∞ (–≤ –æ–¥–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ)
make test-shutdown

# –í –¥—Ä—É–≥–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ - –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
make restart-worker    # Graceful restart
make scale-down       # –£–º–µ–Ω—å—à–µ–Ω–∏–µ –¥–æ 1 worker'–∞
make scale-up         # –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –¥–æ 3 worker'–æ–≤
```

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–æ—Å—Ç–æ—è–Ω–∏—è
```bash
make status   # –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö worker'–æ–≤
make health   # –û–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
make logs     # –õ–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
```

## –°—Ç–∞—Ç—É—Å—ã Worker'–æ–≤

Worker'—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Å–ª–µ–¥—É—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:

- **`worker_started`** - worker –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ
- **`shutdown_started`** - –ø–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è graceful shutdown
- **`shutdown_completed`** - worker –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É

## API Endpoints

### GET /workers/status
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Å–µ—Ö worker'–∞—Ö:
```json
{
  "total_workers": 2,
  "active_workers": 2,
  "shutting_down_workers": 0,
  "workers": {
    "worker_container_1": {
      "status": "worker_started",
      "current_task": null,
      "last_update": 1703123456,
      "seconds_since_update": 5,
      "is_responsive": true
    }
  }
}
```

### GET /health
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã:
```json
{
  "status": "ok",
  "kafka_connected": true,
  "producer_ready": true,
  "active_workers": 2
}
```

## –ü—Ä–æ—Ü–µ—Å—Å Graceful Shutdown

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞** (SIGTERM)
   ```
   üõë Worker worker_1 received SIGTERM, initiating graceful shutdown...
   ```

2. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ shutdown**
   ```
   üì° Worker worker_1 sent shutdown_started notification
   ```

3. **–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏**
   ```
   ‚è≥ Worker worker_1 waiting for current task task_123 to complete...
   ```

4. **–ó–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**
   ```
   ‚úÖ Worker worker_1 consumer closed
   ‚úÖ Worker worker_1 producer closed
   ```

5. **–§–∏–Ω–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ**
   ```
   üì° Worker worker_1 sent shutdown_completed notification
   üëã Worker worker_1 gracefully shut down
   ```

## –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: Graceful restart
```bash
# –¢–µ—Ä–º–∏–Ω–∞–ª 1
make test-shutdown

# –¢–µ—Ä–º–∏–Ω–∞–ª 2
make restart-worker
```
**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**: Worker –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Ç–µ–∫—É—â—É—é –∑–∞–¥–∞—á—É, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω–∏–∑
```bash
# –¢–µ—Ä–º–∏–Ω–∞–ª 1  
make test-shutdown

# –¢–µ—Ä–º–∏–Ω–∞–ª 2
make scale-down
```
**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**: –õ–∏—à–Ω–∏–µ worker'—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è, –∞–∫—Ç–∏–≤–Ω—ã–π worker –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–æ–π
```bash
# Graceful shutdown
docker-compose restart worker

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
docker-compose kill worker
```

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- **Thread-safe**: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Lock –¥–ª—è –∑–∞—â–∏—Ç—ã —Å–æ—Å—Ç–æ—è–Ω–∏—è
- **Timeout protection**: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
- **Manual commit**: —Ä—É—á–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π Kafka
- **Monitoring**: —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–µ—Ä–µ–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- **Resilience**: —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏ graceful shutdown —á–∞—Å—Ç–∏ worker'–æ–≤

## –õ–æ–≥–∏ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

–í–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è —Å emoji –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞:
- üöÄ –ó–∞–ø—É—Å–∫ worker'–∞
- üõë –ù–∞—á–∞–ª–æ shutdown
- ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á–∏  
- üßπ –ü—Ä–æ—Ü–µ—Å—Å cleanup
- üëã –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã
- üì° –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π 